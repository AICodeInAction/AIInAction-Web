generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  githubId      String?   @unique @map("github_id")
  githubUrl     String?   @map("github_url")
  bio           String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts           Account[]
  sessions           Session[]
  completions        ChallengeCompletion[]
  projects           SharedProject[]
  authoredChallenges Challenge[]        @relation("AuthoredChallenges")
  challengeLikes     ChallengeLike[]
  challengeComments  ChallengeComment[]
  stats              UserStats?
  achievements       UserAchievement[]
  apiKeys            ApiKey[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Category {
  id          String      @id @default(cuid())
  slug        String      @unique
  name        String
  description String?     @db.Text
  icon        String?
  color       String?
  order       Int         @default(0)
  isOfficial  Boolean     @default(false) @map("is_official")
  challenges  Challenge[]
  createdAt   DateTime    @default(now()) @map("created_at")

  @@map("categories")
}

model Tag {
  id         String         @id @default(cuid())
  name       String         @unique
  challenges ChallengeTag[]

  @@map("tags")
}

model ChallengeTag {
  challengeId String    @map("challenge_id")
  tagId       String    @map("tag_id")
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  tag         Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([challengeId, tagId])
  @@map("challenge_tags")
}

model LearningPath {
  id          String      @id @default(cuid())
  slug        String      @unique
  title       String
  description String      @db.Text
  icon        String
  color       String
  order       Int         @default(0)
  challenges  Challenge[]
  createdAt   DateTime    @default(now()) @map("created_at")

  @@map("learning_paths")
}

model Challenge {
  id            String     @id @default(cuid())
  slug          String     @unique
  title         String
  description   String     @db.Text
  difficulty    Difficulty
  objectives    String[]
  hints         String[]
  resources     String[]
  estimatedTime String?    @map("estimated_time")
  order         Int        @default(0)

  isOfficial    Boolean    @default(false) @map("is_official")
  authorId      String?    @map("author_id")
  author        User?      @relation("AuthoredChallenges", fields: [authorId], references: [id])
  forkedFromId  String?    @map("forked_from_id")
  forkedFrom    Challenge? @relation("Forks", fields: [forkedFromId], references: [id])
  forks         Challenge[] @relation("Forks")
  likesCount    Int        @default(0) @map("likes_count")

  categoryId    String?    @map("category_id")
  category      Category?  @relation(fields: [categoryId], references: [id])

  pathId        String?    @map("path_id")
  path          LearningPath? @relation(fields: [pathId], references: [id])

  tags          ChallengeTag[]
  completions   ChallengeCompletion[]
  projects      SharedProject[]
  likes         ChallengeLike[]
  comments      ChallengeComment[]
  translations  ChallengeTranslation[]

  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  @@map("challenges")
}

model ChallengeTranslation {
  id          String    @id @default(cuid())
  challengeId String    @map("challenge_id")
  locale      String
  title       String
  description String    @db.Text
  objectives  String[]
  hints       String[]
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, locale])
  @@map("challenge_translations")
}

model ChallengeCompletion {
  id          String           @id @default(cuid())
  userId      String           @map("user_id")
  challengeId String           @map("challenge_id")
  status      CompletionStatus @default(IN_PROGRESS)
  completedAt DateTime?        @map("completed_at")
  reflection  String?          @db.Text
  isPublic    Boolean          @default(true) @map("is_public")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@map("challenge_completions")
}

model SharedProject {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  challengeId String?   @map("challenge_id")
  title       String
  description String    @db.Text
  githubUrl   String    @map("github_url")
  demoUrl     String?   @map("demo_url")
  thumbnail   String?
  tags        String[]
  likes       Int       @default(0)

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge? @relation(fields: [challengeId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("shared_projects")
}

model ChallengeLike {
  userId      String   @map("user_id")
  challengeId String   @map("challenge_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")

  @@id([userId, challengeId])
  @@map("challenge_likes")
}

model ChallengeComment {
  id          String   @id @default(cuid())
  content     String   @db.Text
  userId      String   @map("user_id")
  challengeId String   @map("challenge_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("challenge_comments")
}

model UserStats {
  id             String    @id @default(cuid())
  userId         String    @unique @map("user_id")
  xp             Int       @default(0)
  level          Int       @default(1)
  currentStreak  Int       @default(0) @map("current_streak")
  longestStreak  Int       @default(0) @map("longest_streak")
  lastActiveDate DateTime? @map("last_active_date")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("user_stats")
}

model Achievement {
  id          String            @id @default(cuid())
  slug        String            @unique
  name        String
  description String
  icon        String
  xpReward    Int               @default(0) @map("xp_reward")
  rarity      AchievementRarity @default(COMMON)
  unlockedBy  UserAchievement[]
  createdAt   DateTime          @default(now()) @map("created_at")

  @@map("achievements")
}

model UserAchievement {
  userId        String      @map("user_id")
  achievementId String      @map("achievement_id")
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt    DateTime    @default(now()) @map("unlocked_at")

  @@id([userId, achievementId])
  @@map("user_achievements")
}

model ApiKey {
  id         String    @id @default(cuid())
  key        String    @unique
  name       String    @default("Default")
  userId     String    @map("user_id")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@map("api_keys")
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CompletionStatus {
  IN_PROGRESS
  COMPLETED
}
